---
title: "lme4qtl: an efficient and flexible QTL mapper"
subtitle: "The ESHG 2016 conference, Barcelona, Spain"
author: Andrey Ziyatdinov
date: May, 2016 <br/> [bit.ly/1UiTZvQ](http://bit.ly/1UiTZvQ)
bibliography: mendeley.bib
output:
  ioslides_presentation:
    css: styles.css
---


```{r setup, echo = FALSE, message = FALSE, cache = FALSE}
# set global chunk options
opts_chunk$set(fig.path = 'figure/', cache.path = 'cache/', echo = FALSE, cache = TRUE, 
  tidy = FALSE, 
  fig.width = 9, fig.height = 4.5, dev = 'png',
  warning = FALSE, message = FALSE)
# upload images automatically? (identity/imgur_upload)
opts_knit$set(upload.fun = identity)
```

```{r inc, cache = FALSE}
library(plyr)
library(ggplot2)
library(gridExtra)

library(pander)

#theme_set(theme_light())
panderOptions('table.split.table', Inf)
panderOptions('knitr.auto.asis', FALSE)

library(devtools)
load_all("~/git/hemostat/lme4qtl")
```

```{r par_plotting}
emphcol <- "#d94d3a" # See styles.css
```

```{r local_fun}
summaryCoef <- function(x, digits = max(3, getOption("digits") - 3),
  signif.stars = getOption("show.signif.stars"), signif.legend = FALSE) 
{ 
  printCoefmat(summary(x)$coefficients, zap.ind = 3, digits = digits, 
    signif.stars = signif.stars, signif.legend = signif.legend)
}
```

```{r dat}
source("R/01-load-data.R") 
```

```{r include_cite, cache = FALSE}
#library(knitcitations)
```

```{r knitcitations, cache = FALSE}
#cite_options(linked = TRUE)
#cite_options(tooltip = TRUE)

#bib <- read.bibtex("mendeley.bib")
```

## About this talk

* Not really a talk (too long)
* Like a R package vignette (as long as necessary)

## About lme4qtl

<span class="emph">lme4qtl</span> $=$ an extension of the <span class="emph">lme4</span> R package

<br/>

<span class="emph">lme4qtl</span> $=$ <span class="emph">l</span>inear <span class="emph">m</span>ixed <span class="emph">e</span>ffects models <span class="emph">4</span> <s>for</s> <span class="emph">qtl</span> mapping


## About lme4qtl user

1. You use mixed models for QTL mapping 
    * Basic models (<span class="emph">efficiency</span>)
    * Advanced models (<span class="emph">flexibility</span>)
2. You code in R
    * If not, just need to learn the formula interface
3. You are a fan of the [lme4](https://github.com/lme4/lme4) R package
    * If not, [dmbates](https://github.com/dmbates) is watching you


<div style="float: right; font-size: 50%;">
![](https://avatars2.githubusercontent.com/u/371258?v=3&s=150)
<br/>
Source: [github.com/dmbates](https://github.com/dmbates)
</div>

# Implementation

## 2-column Layout

<div class="columns-2">
  - Bullet 1
  - Bullet 2
  - Bullet 3

  image.png
</div>

# Results | QTL mapping examples using lme4qtl

## Examples / Models

* Polygenic (quantitative trait)
* Polygenic (binary trait)
* Polygenic (counts)

<br/>

* Association (quantitative trait)
* Linkage (quantitative trait)

<br/>

* GxE (sex-especificity)
* GxE (ageing)

## Data preparation

1. Write the formula of your model
2. Write your data table into a data frame
3. Compute the relation matrix across your grouping IDs

```{r, echo = TRUE, eval = FALSE}
relmatLmer(
  myTrait ~ myCov + (1|ID),     # 1
  myData,                       # 2
  relmat = list(ID = myMatrix)  # 3
)
```

## Description of the GAIT data {.smaller}

|  R objects |  Description  |
|:-----------|:--------------|
| phen/phen2 | A data frame with phenotypes and IDs (GAIT1/GAIT2) |
| dkin/dkin2 | The double kinship matrix with IDs in row/columns names (GAIT1/GAIT2)|

## Description of the GAIT data (variables) {.smaller}

|  Variables in phen  | Type | Project | Description  |
|:-----------|:-----|:--------|:-------------|
| ID  | character | |The individual's ID (must be unique)|
| HHID | character | |The individual's house-hold ID |
| SEXf | factor | |The gender (Male/Female) |
| AGE/AGEc/AGEsc |numeric | |The age (raw/centered/scaled) |
| AGEc2/AGEsc2 | numeric | |The age squared (centered/scaled) |
| APTT | numeric | GAIT1 | Activated Partial Thromboplastin Time (units, sec) |
| Throm | factor | GAIT2 | The thrombosis disease status (control/affected) |


## Models (1/7)

<div style="float: right;">
```{r plot_mod_aptt, fig.width = 4, fig.height = 4}
N <- 20

m <- relmatLmer(APTT ~ AGEc + (1|ID), phen, relmat = list(ID = dkin))

dat <- subset(phen, !is.na(APTT))
set.seed(1)
ind <- sample(seq(1, nrow(dat)), N)
dat <- dat[ind, ]

dat$yf <- predict(m, dat, re.form = NA)
dat$yr <- predict(m, dat, re.form = NULL)

ggplot(dat) + 
  geom_line(aes(AGE, yf), color = emphcol, size = 2) + 
  geom_point(aes(AGE, APTT)) + 
  geom_point(aes(AGE, yr), color = emphcol) + 
  geom_segment(aes(x = AGE, y = yr, xend = AGE, yend = APTT), linetype = 3) +
  theme_void()
```
</div>

* <span class="emph">Polygenic (quantitative trait)</span>
* Polygenic (binary trait)
* Polygenic (counts)

<br/>

* Association (quantitative trait)
* Linkage (quantitative trait)

<br/>

* GxE (sex-especificity)
* GxE (ageing)


## Polygenic model for APTT

```{r aptt, echo = T}
m <- relmatLmer(APTT ~ AGEsc + (1|ID), phen, relmat = list(ID = dkin))
m
```

## Residuals

```{r aptt_res, echo = T}
r <- residuals(m)
```

<div class="columns-2">

```{r aptt_res_1, fig.width = 4, fig.height = 4, echo = T}
qqnorm(r); qqline(r)
```

```{r aptt_res_2, fig.width = 4, fig.height = 4, echo = T}
hist(r, breaks = 30)
```

</div>

## Models (2/7)

<div style="float: right;">

```{r plot_mod_Throm_comp}
N <- 50

K <- 0.05
dat <- mutate(phen2, offset = log(K/(1 - K)))

m <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + (1|ID), dat, offset = offset, relmat = list(ID = dkin2), family = binomial)
m0 <- relmatGlmer(Throm ~ AGEsc + SEXfnum + (1|ID), dat, relmat = list(ID = dkin2), family = binomial) 
  
dat <- subset(phen2, !is.na(AGEsc))
set.seed(1)
ind <- sample(with(dat, which(SEXfnum == 0)), N)
dat <- dat[ind, ]

beta0 <- log(K/(1 - K))
logit <- function(x) 1/(1 + exp(-x))

dat$y <- predict(m, dat, re.form = NULL)
dat$yf <- predict(m, dat, re.form = NA)
dat <- mutate(dat, prob = logit(y + beta0))
dat <- mutate(dat, probf = logit(yf + beta0))

simdat <- data.frame(AGEsc = seq(-2.5, 5, 0.05), SEXfnum = 0)
simdat$y <- predict(m, simdat, re.form = NA)
simdat$y0 <- predict(m0, simdat, re.form = NA)
simdat <- mutate(simdat, prob = logit(y + beta0))
simdat <- mutate(simdat, prob0 = logit(y0))

p1 <- ggplot(simdat) + 
  geom_line(aes(AGEsc, prob), color = emphcol, size = 2) +
  geom_line(aes(AGEsc, prob0), color = emphcol, size = 2, linetype = 3) +
  geom_point(aes(AGEsc, as.numeric(Throm), shape = as.factor(Throm)), dat, size = 2) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(1, 19)) + guides(shape = "none") + theme_void()
```

```{r plot_mod_aff_comp}
N <- 50

K <- 0.05
dat <- mutate(phen, offset = log(K/(1 - K)))

m <- relmatGlmer(aff ~ -1 + AGEsc + SEXfnum + (1|ID), dat, offset = offset, relmat = list(ID = dkin), family = binomial)
m0 <- relmatGlmer(aff ~ AGEsc + SEXfnum + (1|ID), dat, relmat = list(ID = dkin), family = binomial) 
  
dat <- subset(phen, !is.na(AGEsc))
set.seed(1)
ind <- sample(with(dat, which(SEXfnum == 0)), N)
dat <- dat[ind, ]

beta0 <- log(K/(1 - K))
logit <- function(x) 1/(1 + exp(-x))

dat$y <- predict(m, dat, re.form = NULL)
dat$yf <- predict(m, dat, re.form = NA)
dat <- mutate(dat, prob = logit(y + beta0))
dat <- mutate(dat, probf = logit(yf + beta0))

simdat <- data.frame(AGEsc = seq(-2.5, 5, 0.05), SEXfnum = 0)
simdat$y <- predict(m, simdat, re.form = NA)
simdat$y0 <- predict(m0, simdat, re.form = NA)
simdat <- mutate(simdat, prob = logit(y + beta0))
simdat <- mutate(simdat, prob0 = logit(y0))

p2 <- ggplot(simdat) + 
  geom_line(aes(AGEsc, prob), color = emphcol, size = 2) +
  geom_line(aes(AGEsc, prob0), color = emphcol, size = 2, linetype = 3) +
  geom_point(aes(AGEsc, as.numeric(aff), shape = as.factor(aff)), dat, size = 2) +
  geom_hline(yintercept = 0.5, linetype = 2) +
  geom_vline(xintercept = 0, linetype = 2) +
  scale_shape_manual(values = c(1, 19)) + guides(shape = "none") + theme_void()
```

```{r plot_mod_logit, fig.width = 4, fig.height = 4}
#grid.arrange(p1, p2, ncol = 1) # fig.width = 4, fig.height = 2*2.5
p1
```

</div>

* Polygenic (quantitative trait)
* <span class="emph">Polygenic (binary trait)</span>
* Polygenic (counts)

<br/>

* Association (quantitative trait)
* Linkage (quantitative trait)

<br/>

* GxE (sex-especificity)
* GxE (ageing)


## Polygenic model for Throm

```{r m1, echo = TRUE}
m <- relmatGlmer(Throm ~ (1|ID), phen2, relmat = list(ID = dkin2), 
  family = binomial)
m
```

## Covariates

```{r throm_cov2, echo = TRUE}
m <- relmatGlmer(Throm ~ AGEsc + SEXf + ABOf3num + (1|ID), phen2, 
  relmat = list(ID = dkin2), family = binomial)
```

```{r, echo = TRUE}
summaryCoef(m, signif.legend = TRUE)
```


## Disease prevalence 5%

```{r throm_prevalence, echo = TRUE}
K <- 0.05
dat <- mutate(phen2, offset = log(K/(1 - K)))

m <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial)
```

```{r, dependson = -1, echo = T}
summaryCoef(m) # offset = log(K/(1 - K)) = -2.944439
```


## Anova

```{r offset_coef_anova_comp, echo = TRUE}
K <- 0.05
dat <- mutate(subset(phen2, !is.na(ABOf3num)), offset = log(K/(1 - K)))

m <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial)
m0 <- update(m, . ~ . - ABOf3num)
```

```{r offset_coef_anova_show, dependson = -1, echo = TRUE}
anova(m, m0) # offset = log(K/(1 - K)) = -2.944439
```

## Probit link function

```{r probit, echo = TRUE}
K <- 0.05
dat <- mutate(phen2, offset = -qnorm(1 - K))

m <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial(probit))  
```

```{r, echo = TRUE}
summaryCoef(m)  # offset = -qnorm(1 - K) = -1.644854
```

## Modeling prevalence?

<div class="columns-2">

<div class="centered">
GAIT2 (118 _vs._ 817)
</div>

```{r p1, fig.width = 4, fig.height = 4.5}
p1
```


<div class="centered">
GAIT1 (53 _vs._ 340)
</div>

```{r p2, fig.width = 4, fig.height = 4.5}
p2
```

</div>

See also [@Zaitlen2012]

## Thank you

* The official repository at [github.com/variani/lme4qtl](https://github.com/variani/lme4qtl)
* This presentation lives here [bit.ly/1UiTZvQ](http://bit.ly/1UiTZvQ)

# More examples 

## Examples 

* ABO covariate effect
    * comparision of two tests, t-test _vs._ anova
* Categorical age effect
    * increasing disease risk with age (non-linearly?)


## ABO covariate effect (t-test)

```{r throm_cov, echo = TRUE}
K <- 0.05
dat <- mutate(subset(phen2, !is.na(ABOf3num)), offset = log(K/(1 - K)))

m <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial)
```

```{r, dependson = -1, echo = TRUE}
summaryCoef(m, signif.legend = TRUE) 
```

## ABO covariate effect (anova)

```{r throm_cov_test, echo = TRUE}
K <- 0.05
dat <- mutate(subset(phen2, !is.na(ABOf3num)), offset = log(K/(1 - K)))

m <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial)
m0 <- update(m, . ~ . - ABOf3num)
```

```{r, dependson = -1, echo = TRUE}
anova(m, m0) 
```

## ABO covariate effect (summary)

|  Model | Estimate | Std. Error | z-value |
|:-------|:-----|:------------|:---------|
| Intercept-free | -0.5584 | 0.2160 | -2.585 |
| Intercept (prevalence) | -0.5662 | 0.2384 | **-2.374** |

<br/>

|  Model | p-value (t-test) | p-value (anova) |
|:-------|:--------|:---|
| Intercept-free | 0.00973 (`**`) | 0.005092 (`**`) |
| Intercept (prevalence) | **0.0176** (`*`) | 0.004031 (`**`) |


## Categorical age effect

```{r tab_AGEf}
tab <- ddply(phen2, "AGEf", summarize, 
  Range = paste("[", 
    paste(round(range(AGE, na.rm = TRUE), 1), collapse = " - "), 
    "]", collapse = ""), 
  N = sum(!is.na(AGE)))
```

```{r, dependson = -1, results = 'asis'}
tab <- tab[1:5, ]

colnames(tab) <- c("Factor level of AGEf", "Range of AGE", "Number of ind.")

pander(tab, style = 'rmarkdown')
```

## Categorical age effect

```{r m_AGEf, echo = TRUE} 
K <- 0.05
dat <- mutate(phen2, offset = -qnorm(1 - K))

m <- relmatGlmer(Throm ~ AGEf + SEXf + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial(probit))
```  

```{r, dependson = -1, echo = T}
summaryCoef(m)
```

# Caveats

## Caveats

* Disease prevalence 1%

## Disease prevalence 1%

```{r throm_prevalence2, echo = TRUE}
K <- 0.01
dat <- mutate(phen2, offset = log(K/(1 - K)))

m1 <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial) 
```

```{r, dependson = -1, echo = TRUE}
summaryCoef(m1) # offset = log(K/(1 - K)) = -4.59512  
```

## Disease prevalence 1% (nloptwrap)

```{r throm_prevalence3, warning = TRUE, message = TRUE, echo = TRUE}
m2 <- relmatGlmer(Throm ~ -1 + AGEsc + SEXfnum + ABOf3num + (1|ID), dat, 
  offset = offset, relmat = list(ID = dkin2), family = binomial,
  control = glmerControl(optimizer = "nloptwrap"))
```

```{r, dependson = -1, echo = TRUE}
summaryCoef(m2) # offset = log(K/(1 - K)) = -4.59512
```

## References
